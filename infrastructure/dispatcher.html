<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AEM Tutorial - Dispatcher</title>
        <meta name="description" content="Master Adobe Experience Manager (AEM) with our in-depth tutorials, covering AEM components, workflows, servlets, models, Sling, OSGi services, Touch UI dialogs, CRXDE, and more. Perfect for beginners, advanced developers, and AEM architects looking to enhance their skills. Learn how to build scalable and efficient AEM solutions with best practices.">
        <meta name="keywords" content="AEM, Adobe Experience Manager, AEM Tutorial, AEM Training, AEM Components, AEM Workflows, AEM Servlets, AEM Models, AEM Sling, AEM OSGi, AEM Touch UI, AEM CRXDE, AEM DAM, AEM Metadata, AEM Content Fragments, AEM Experience Fragments, AEM Editable Templates, AEM Dispatcher, AEM Forms, AEM Sites, AEM Assets, AEM Cloud, AEM as a Cloud Service, AEM On-Premise, AEM SEO, AEM Best Practices, Learn AEM, AEM Course, AEM Development, AEM Headless, AEM SPA, AEM React, AEM Angular, AEM HTL, AEM Sightly, AEM Frontend, AEM Backend, AEM Workflow Development, AEM Performance Optimization, AEM Interview Questions">
        <meta name="author" content="Ashish Raj">
		<link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <link rel="stylesheet" href="../css/styles.css">
    </head>
    <body>
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>AEM Tutorial</h2>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebarSearch" placeholder="🔍 Search..." />
            </div>
            <nav class="nav" id="sidebar-nav"></nav>
            <div class="footer">
                <p>&copy; 2025 AEM Tutorial</p>
            </div>
        </div>
        <span class="hamburger" onclick="toggleMenu()">&#9776;</span>
        <main class="content" id="content">
            <h1>Dispatcher</h1>
            <section class="card">
                <h2>Introduction to Dispatcher</h2>
                <p>
                    The <strong>Dispatcher</strong> is Adobe Experience Manager's (AEM) caching and load balancing tool that helps improve the 
                    performance, scalability, and security of your AEM-based website. It acts as a reverse proxy that sits between the client 
                    and AEM publish instances, caching responses and distributing traffic across multiple instances.
                </p>
                <p>
                    The Dispatcher is tightly integrated with popular web servers such as 
                    <strong>Apache HTTP Server</strong> or <strong>Microsoft IIS</strong>, and is configured using a plain text configuration 
                    file called <code>dispatcher.any</code>.
                </p>
                <p>
                    The main goals of the Dispatcher are:
                </p>
                <ul>
                    <li>Reduce load on AEM publish servers by serving cached pages</li>
                    <li>Provide load balancing for better traffic distribution and failover</li>
                    <li>Improve security by filtering unwanted or unauthorized requests</li>
                </ul>
                <p>
                    Whether you're deploying AEM on-premise or using <strong>AEM as a Cloud Service</strong>, the Dispatcher is an essential 
                    component for building high-performance and secure web experiences.
                </p>
            </section>
            <section class="card">
                <h2>Dispatcher Architecture</h2>
                <h3>How Dispatcher Works</h3>
                <p>
                    The Dispatcher acts as a reverse proxy sitting between the client and AEM publish instances. It primarily checks whether
                    the requested content is already cached and decides how to handle the request.
                </p>
                <ul>
                    <li>
                        <strong>Cache Hit:</strong> If the content is available in the cache, the Dispatcher serves it directly, bypassing AEM.
                    </li>
                    <li>
                        <strong>Cache Miss:</strong> If the content is not available in the cache, the Dispatcher forwards the request to AEM,
                        stores the response in the cache, and returns it to the client.
                    </li>
                </ul>
                <h3>Components of Dispatcher Architecture</h3>
                <p>
                    The Dispatcher architecture typically consists of the following layers and components:
                </p>
                <ul>
                    <li>
                        <strong>Client:</strong> End-user or browser that initiates a request.
                    </li>
                    <li>
                        <strong>Web Server:</strong> Apache HTTP Server or Microsoft IIS running the Dispatcher module.
                    </li>
                    <li>
                        <strong>Dispatcher Module:</strong> Executes caching and load balancing logic.
                    </li>
                    <li>
                        <strong>AEM Publish Instances:</strong> Serve dynamic content and render pages or assets.
                    </li>
                    <li>
                        <strong>AEM Author Instance (optional):</strong> Used when activating/publishing content, triggering cache invalidation.
                    </li>
                </ul>
                <h4>Flow Summary:</h4>
                <ol>
                    <li>User makes a request to a URL.</li>
                    <li>Dispatcher checks if the content is cached.</li>
                    <li>If cached, response is returned directly.</li>
                    <li>If not cached, request is forwarded to AEM Publish, response is cached, then sent to user.</li>
                    <li>Cache can be invalidated automatically (via flush agent) or manually (via admin/scripts).</li>
                </ol>
                <h3>Sample Dispatcher Folder Structure</h3>
                <p>
                    Here's a typical folder structure when configuring Dispatcher with Apache HTTP Server:
                </p>
                <pre>
/etc/httpd
├── conf.d
│   ├── dispatcher.conf               # Dispatcher module configuration
│   ├── farms/
│   │   ├── publish.farm              # Farm configuration for publish instances
│   │   └── flush.farm                # Flush agent configuration
│   └── rewrites/
│       └── rewrite.rules             # URL rewriting rules
├── dispatcher.any                    # Main Dispatcher configuration file
└── logs/                             # Web server and Dispatcher logs
  </pre>
                <p>
                    This modular structure promotes separation of concerns — rewrite rules, farm definitions, and dispatcher configuration are
                    organized into separate files for easier maintenance and clarity.
                </p>
            </section>
            <section class="card">
                <h2>Key Capabilities of Dispatcher</h2>
                <h3>Key Functions of Dispatcher</h3>
                <p>The AEM Dispatcher is a powerful tool designed to boost performance, scalability, and security of AEM-based websites. Its core capabilities include:</p>
                <ul>
                    <li><strong>Caching:</strong> Reduces load on publish instances by storing and serving static content such as HTML, CSS, JS, and images.</li>
                    <li><strong>Load Balancing:</strong> Distributes incoming HTTP requests across multiple AEM publish instances to ensure availability and responsiveness.</li>
                    <li><strong>Request Filtering:</strong> Protects AEM from malicious or unwanted requests using filtering rules.</li>
                    <li><strong>Cache Invalidation:</strong> Supports automatic and manual cache invalidation mechanisms based on replication or time-based rules.</li>
                    <li><strong>Access Control:</strong> Can restrict access to resources based on IP address, headers, or URL patterns.</li>
                    <li><strong>Integration with CDN:</strong> Can be used alongside a Content Delivery Network to extend caching and security at a global scale.</li>
                </ul>
                <h3>Common Dispatcher Use Cases</h3>
                <ul>
                    <li><strong>Static Content Caching:</strong> Improve site speed and reduce server load by caching assets like images, JavaScript, and stylesheets.</li>
                    <li><strong>Dynamic Page Caching:</strong> Cache rendered HTML pages when possible, and use stat files to invalidate content when updates happen.</li>
                    <li><strong>Load Distribution:</strong> Improve reliability and scale by spreading traffic across multiple AEM publish instances.</li>
                    <li><strong>Multisite Hosting:</strong> Handle multiple domains and configurations using multiple farms within a single dispatcher setup.</li>
                    <li><strong>Security Filtering:</strong> Block direct access to CRXDE, /libs, /apps, and other sensitive AEM paths via dispatcher rules.</li>
                    <li><strong>Geographic Caching via CDN:</strong> Pair Dispatcher with CDN to deliver content faster worldwide.</li>
                </ul>
            </section>
            <section class="card">
                <h2>Dispatcher.any Configuration Overview</h2>
                <p>The <code>dispatcher.any</code> file is the primary configuration file used to control caching, filtering, and routing behaviors for the Dispatcher module. It defines the behavior of farms, caching policies, invalidation strategies, allowed client IPs, and more.</p>
                <h3>Key Configuration Nodes</h3>
                <ul>
                    <li><strong>/farms:</strong> Root configuration node. Each farm represents a logical group for publish instances.</li>
                    <li><strong>/cache:</strong> Controls what is cached, where it's stored, and how long it is retained.</li>
                    <li><strong>/rules:</strong> Specifies URL patterns to allow or deny for caching.</li>
                    <li><strong>/statfileslevel:</strong> Defines the depth in the content hierarchy at which statfiles are created for cache invalidation.</li>
                    <li><strong>/invalidate:</strong> Specifies patterns to be invalidated when changes are made.</li>
                    <li><strong>/filter:</strong> Controls access to AEM paths via allow/deny rules.</li>
                    <li><strong>/allowAuthorized:</strong> Allows caching of authenticated (authorized) content when set to <code>1</code>.</li>
                    <li><strong>/virtualhosts:</strong> Maps domains/hostnames to this farm configuration.</li>
                    <li><strong>/renders:</strong> Defines the list of AEM publish instances this farm connects to.</li>
                </ul>
                <h3>Sample dispatcher.any Snippet</h3>
                <pre>
/farms {
  /publish-farm {
    /clientheaders {
      "User-Agent"
      "Referer"
    }

    /virtualhosts {
      "*"
    }

    /renders {
      /render1 {
        /hostname "localhost"
        /port "4503"
      }
    }

    /filter {
      /0001 { /type "deny" /url "/libs/*" }
      /0002 { /type "allow" /url "/content/*" }
    }

    /cache {
      /docroot "/opt/cache"
      /rules {
        /0001 { /glob "*.html" /type "allow" }
        /0002 { /glob "*.css" /type "allow" }
        /0003 { /glob "*.js" /type "allow" }
      }
      /statfileslevel "3"
      /statfile "/statfile"
    }

    /invalidate {
      /0000 { /glob "*" /type "allow" }
    }

    /allowAuthorized "1"
  }
}</pre>
                <h3>Best Practices for dispatcher.any</h3>
                <ul>
                    <li>Always deny everything first, then allow specific content paths for caching or access.</li>
                    <li>Use <code>/statfileslevel</code> and <code>/statfile</code> properly to support cache invalidation with AEM replication.</li>
                    <li>Separate farms for different domains/sites if needed.</li>
                    <li>Avoid caching user-specific or sensitive content unless <code>/allowAuthorized</code> is explicitly used with care.</li>
                    <li>Document each rule clearly and test configuration changes in staging environments.</li>
                </ul>
            </section>
            <section class="card">
                <h2>URL Rewriting in Dispatcher</h2>
                <p>URL rewriting helps in mapping clean or user-friendly URLs to actual content paths in AEM. It is typically handled using Apache's <code>mod_rewrite</code> module and a <code>rewrite.rules</code> file.</p>
                <h3>Why URL Rewriting?</h3>
                <ul>
                    <li>Improve SEO with clean URLs (e.g., <code>/product</code> instead of <code>/content/site/en/product.html</code>)</li>
                    <li>Redirect old paths to new ones after content restructure</li>
                    <li>Add/remove extensions like <code>.html</code></li>
                </ul>
                <h3>Example Rewrite Rule (Apache)</h3>
                <pre>
RewriteEngine On
RewriteRule ^/product$ /content/site/en/product.html [PT,L]</pre>
                <h3>Where to Define?</h3>
                <p>Place rewrite rules in:</p>
                <ul>
                    <li><code>/etc/httpd/conf.d/rewrites/rewrite.rules</code> (Apache)</li>
                    <li>Or <code>conf.dispatcher.d/rewrites/</code> (in AEMaaCS Dispatcher SDK)</li>
                </ul>
                <h3>Best Practices</h3>
                <ul>
                    <li>Keep rules modular and organized in separate files</li>
                    <li>Test rules locally before deploying</li>
                    <li>Avoid rewriting internal tools paths like <code>/libs</code>, <code>/crx</code>, etc.</li>
                </ul>
            </section>
            <section class="card">
                <h2>Caching & Invalidation in Dispatcher</h2>
                <p>Dispatcher provides robust caching features to enhance performance by offloading requests from AEM publish instances. Caching behavior is defined under the <code>/cache</code> and <code>/rules</code> nodes, and content invalidation ensures users always see the latest published content.</p>
                <h3>1. Caching Strategy Examples</h3>
                <p>Dispatcher caches content based on URL patterns and file types using the <code>/rules</code> configuration inside <code>/cache</code>. Below is a sample configuration:</p>
                <pre>
/cache {
  /docroot "/var/www/html"
  /rules {
    /0001 { /glob "*.html"  /type "allow" }
    /0002 { /glob "*.css"   /type "allow" }
    /0003 { /glob "*.js"    /type "allow" }
    /0004 { /glob "*.jpg"   /type "allow" }
  }
  /statfileslevel "3"
  /statfile "/statfile"
}</pre>
                <p>This setup allows caching of HTML, CSS, JS, and image files under the defined docroot.</p>
                <h3>2. Stat Files & <code>statfileslevel</code></h3>
                <p>The <code>statfileslevel</code> setting determines at which content hierarchy level Dispatcher will look for stat files (used for cache invalidation). For example, if set to <code>3</code>, changes under <code>/content/site/en/about</code> would create/update <code>/statfiles/content/site/en</code>.</p>
                <ul>
                    <li><code>/statfile</code>: Name of the stat file used to compare timestamps for invalidation.</li>
                    <li><code>/statfileslevel</code>: Depth in the content path where stat files are created.</li>
                </ul>
                <p>These are essential for automatic cache invalidation triggered by page activation in AEM.</p>
                <h3>3. Ignoring URL Parameters</h3>
                <p>Dispatcher can ignore URL parameters that don't affect content rendering to avoid unnecessary cache fragmentation. For example:</p>
                <pre>
/ignoreUrlParams {
  /0001 { /glob "*"          /type "deny"  }
  /0002 { /glob "nocache=*"  /type "allow" }
}</pre>
                <p>This ensures all URLs with tracking or irrelevant query params point to the same cached resource.</p>
                <h3>4. Invalidation Triggers</h3>
                <p>Dispatcher cache is invalidated when:</p>
                <ul>
                    <li><strong>Flush Agent:</strong> AEM publishes content and triggers the Dispatcher Flush Agent.</li>
                    <li><strong>Stat File Timestamp:</strong> If stat file is newer than cached file, the cache entry is invalidated.</li>
                    <li><strong><code>/invalidate</code> Rules:</strong> Specific patterns defined to invalidate cache on change.</li>
                    <li><strong>Manual Invalidation:</strong> Administrators delete cache files manually (rare but possible).</li>
                </ul>
                <p>Sample invalidation rule:</p>
                <pre>
/invalidate {
  /0000 { /glob "*" /type "allow" }
}</pre>
                <h3>5. Fragment Caching (Optional)</h3>
                <p>Instead of caching full pages, Dispatcher can cache reusable fragments like headers, footers, or components using SSI (Server-Side Includes). This provides a balance between dynamic and static content:</p>
                <ul>
                    <li>Use <code>data-sly-resource</code> and <code>data-sly-include</code> in HTL.</li>
                    <li>Combine with <code>include</code> directives in Apache.</li>
                    <li>SSI caching can be used selectively for performance tuning.</li>
                </ul>
                <h3>6. Header Caching & CDN Integration</h3>
                <p>To improve cache behavior across browsers and CDNs:</p>
                <ul>
                    <li><strong>Set Cache-Control headers:</strong> Define <code>max-age</code> or <code>Expires</code> values in the response.</li>
                    <li><strong>Short-lived vs Long-lived Caching:</strong> Assets can be cached longer, dynamic pages shorter.</li>
                    <li><strong>CDN Integration:</strong> Leverage a CDN (like Akamai or Cloudflare) to cache Dispatcher content at edge locations globally.</li>
                    <li><strong>Header Caching:</strong> Ensure headers like <code>ETag</code>, <code>Last-Modified</code>, and <code>Vary</code> are configured correctly.</li>
                </ul>
                <p>Apache example to set cache headers:</p>
                <pre>
&lt;FilesMatch "\.(jpg|png|css|js|html)$"&gt;
  Header set Cache-Control "max-age=86400, public"
&lt;/FilesMatch&gt;</pre>
            </section>
            <section class="card">
                <h2>Load Balancing Configuration</h2>
                <p>Dispatcher supports load balancing to distribute incoming traffic across multiple AEM publish instances, enhancing scalability and availability of your AEM environment.</p>
                <h3>1. Round Robin Load Balancing</h3>
                <p>In a round-robin setup, Dispatcher forwards each request to the next available render (publish) instance in a circular order.</p>
                <pre>
/farms {
  /publish-farm {
    /renders {
      /render1 {
        /hostname "publish1.example.com"
        /port "4503"
      }
      /render2 {
        /hostname "publish2.example.com"
        /port "4503"
      }
    }
    /loadbalancer {
      /stickyConnectionsFor "aem-site"
      /scheduler {
        /type "round-robin"
      }
    }
  }
}</pre>
                <p>This configuration defines two render instances and enables round-robin distribution of requests between them.</p>
                <h3>2. Sticky Sessions</h3>
                <p>Sticky sessions (or session affinity) ensure a user's session is always served by the same publish instance. This is essential for session-based personalization and login-dependent features.</p>
                <p>To enable sticky connections:</p>
                <ul>
                    <li>Use the <code>/stickyConnectionsFor</code> node with the virtual host name.</li>
                    <li>This preserves session continuity during the user's visit.</li>
                </ul>
                <h3>3. Health Checks Example</h3>
                <p>Dispatcher performs health checks to ensure requests are routed only to healthy publish instances. If a render is unreachable, it's temporarily removed from the pool.</p>
                <p>Example configuration for health checks:</p>
                <pre>
/renders {
  /render1 {
    /hostname "publish1.example.com"
    /port "4503"
    /health_check {
      /uri "/system/health"
      /interval "60"
      /timeout "5"
    }
  }
}</pre>
                <ul>
                    <li><code>/uri</code>: Path Dispatcher uses to check instance health (e.g., a custom servlet that returns 200 OK).</li>
                    <li><code>/interval</code>: Time in seconds between health check calls.</li>
                    <li><code>/timeout</code>: Max wait time in seconds for a response.</li>
                </ul>
                <p><strong>Best Practice:</strong> Create a custom lightweight servlet (e.g., <code>/system/health</code>) that simply returns <code>200 OK</code> to validate the instance's status.</p>
            </section>
            <section class="card">
                <h2>Security Configuration in Dispatcher</h2>
                <p>Dispatcher plays a crucial role in securing your AEM environment by filtering malicious or unauthorized requests before they reach the AEM publish instances. It acts as the first layer of defense in your web architecture.</p>
                <h3>1. /filter Rules</h3>
                <p>The <code>/filter</code> section defines which requests are allowed or denied. It's vital to block access to AEM consoles, internal paths, or sensitive endpoints.</p>
                <pre>
/filter {
  /0001 { /type "deny" /glob "/libs/granite/csrf/token.json" }
  /0002 { /type "deny" /glob "/crx/*" }
  /0003 { /type "deny" /glob "/system/*" }
  /0004 { /type "allow" /glob "/content/*" }
  /0005 { /type "allow" /glob "/etc.clientlibs/*" }
}</pre>
                <ul>
                    <li><code>/type "deny"</code>: Blocks matching URLs.</li>
                    <li><code>/type "allow"</code>: Permits matching URLs.</li>
                    <li><code>/glob</code>: Supports wildcard-style pattern matching.</li>
                </ul>
                <h3>2. /allowedClients</h3>
                <p>Restrict access to Dispatcher based on client IP addresses. Useful for staging or admin-only environments.</p>
                <pre>
/allowedClients {
  /0001 { /glob "*" /type "deny" }
  /0002 { /glob "192.168.1.*" /type "allow" }
  /0003 { /glob "127.0.0.1" /type "allow" }
}</pre>
                <h3>3. /unavailable Page</h3>
                <p>Configure a custom page to show when the Dispatcher blocks access:</p>
                <pre>
/unavailable {
  /url "/content/site/en/error/403.html"
}</pre>
                <p>This ensures users see a friendly error page rather than a blank or raw error response.</p>
                <h3>4. Vanity URLs and Dispatcher Filter Rules</h3>
                <p>If your AEM site uses vanity URLs (e.g., <code>/product-a</code> instead of <code>/content/site/en/products/product-a.html</code>), you need to explicitly allow them in <code>dispatcher.any</code>.</p>
                <h4>Basic Example:</h4>
                <pre>
/filter {
  /0001 { /type "allow" /url "/product-a" }
  /0002 { /type "allow" /url "/product-b" }
}</pre>
                <h4>If Your URLs Don't Have Extensions (e.g., No <code>.html</code>):</h4>
                <p>Ensure Dispatcher is configured to support extensionless URLs, and web server rewrite rules are also properly set.</p>
                <h4>Bonus: Enable access for authenticated users</h4>
                <pre>/allowAuthorized "1"</pre>
                <p>This allows requests with login credentials (cookies, headers) to pass through to AEM.</p>
                <p><strong>Best Practices:</strong></p>
                <ul>
                    <li>Don't blindly allow all URLs—specify only those needed.</li>
                    <li>Keep vanity paths short and memorable.</li>
                    <li>Use AEM's <strong>Vanity URL Report</strong> to track and manage vanity paths.</li>
                </ul>
            </section>
            <section class="card">
                <h2>Monitoring, Logging & Cache Management</h2>
                <p>Effective monitoring and cache control are essential for maintaining Dispatcher performance, diagnosing issues, and ensuring timely content delivery.</p>
                <h3>1. Logging in Dispatcher</h3>
                <p>Dispatcher provides log files that can be used to analyze request handling, caching behavior, and issues during cache invalidation.</p>
                <ul>
                    <li><strong>Dispatcher Log File Location:</strong> Usually found under <code>/logs/dispatcher.log</code> or configured in <code>dispatcher.conf</code>.</li>
                    <li><strong>LogLevel Configuration (Apache):</strong></li>
                    <pre>
# Inside dispatcher.conf or apache config
DispatcherLogLevel 3
DispatcherLog    "/var/log/httpd/dispatcher.log"</pre>
                    <li>
                        <strong>LogLevel meanings:</strong>
                        <ul>
                            <li><code>0</code>: Errors only</li>
                            <li><code>1</code>: Warnings</li>
                            <li><code>2</code>: Informational</li>
                            <li><code>3</code>: Debug level (most verbose)</li>
                        </ul>
                    </li>
                </ul>
                <h3>2. Cache Flush Behavior</h3>
                <p>The Dispatcher cache is automatically invalidated based on triggers such as content activation or manual deletion. Here's how it works:</p>
                <h4>a. Auto Cache Invalidation via Flush Agents</h4>
                <p>In AEM, you configure flush agents on publish instances to notify Dispatcher when content is activated or deactivated.</p>
                <ul>
                    <li>Dispatcher deletes or updates the corresponding cache files.</li>
                    <li>Flush agents are configured at: <code>/etc/replication/agents.publish/dispatcher</code></li>
                </ul>
                <h4>b. Stat File-Based Invalidation</h4>
                <p>The statfile's timestamp is updated on activation, triggering invalidation based on folder depth defined by <code>/statfileslevel</code>.</p>
                <pre>/statfileslevel "3"</pre>
                <p>For example, if a page under <code>/content/site/en/home</code> is updated, and <code>statfileslevel</code> is 3, only that subtree is invalidated.</p>
                <h4>c. Manual Cache Flush</h4>
                <ul>
                    <li>Developers can manually delete the Dispatcher cache directory (carefully).</li>
                    <li>Use scripting or CI/CD tools to clear cache during deployments if needed.</li>
                </ul>
                <h4>d. Cache Folder Location</h4>
                <p>Set in the Apache <code>dispatcher.conf</code> or <code>dispatcher.any</code> file, typically like:</p>
                <pre>/docroot "/var/www/html"</pre>
                <h3>3. Monitoring Best Practices</h3>
                <ul>
                    <li>Monitor cache hit/miss ratios via logs.</li>
                    <li>Use monitoring tools (e.g., Prometheus + custom scripts) to track cache directory size and performance.</li>
                    <li>Set up alerting for Dispatcher unavailability or excessive cache invalidation events.</li>
                </ul>
                <h3>4. Pro Tip: Logging Cache Behavior</h3>
                <p>You can track cache hits and misses in Apache access logs. Use log formats like:</p>
                <pre>LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %X" combined</pre>
                <p>Tools like <strong>GoAccess</strong> or <strong>AWStats</strong> can help analyze these logs visually.</p>
            </section>
            <section class="card">
                <h2>Dispatcher Tools & Best Practices</h2>
                <p>Following best practices ensures that your Dispatcher setup remains efficient, secure, and maintainable across both traditional AEM and AEM as a Cloud Service (AEMaaCS) environments.</p>
                <h3>1. Flush Agents</h3>
                <p>Flush Agents are configured on AEM publish instances to communicate with Dispatcher and trigger cache invalidation when content is activated or deactivated.</p>
                <ul>
                    <li>Navigate to: <code>/etc/replication/agents.publish</code> in AEM.</li>
                    <li>Each flush agent should point to your Dispatcher endpoint (e.g., <code>http://localhost:80/dispatcher/invalidate.cache</code>).</li>
                    <li>Set transport credentials and make sure the agent is enabled and tested.</li>
                </ul>
                <h3>2. Apache Security Headers</h3>
                <p>Enhance your site's security by setting HTTP response headers in your Apache virtual host (or Dispatcher conf):</p>
                <pre>
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set X-Content-Type-Options "nosniff"
Header always set Content-Security-Policy "default-src 'self'"</pre>
                <p>These headers help mitigate risks like clickjacking, XSS attacks, and MIME-type sniffing.</p>
                <h3>3. CI/CD Tips for AEMaaCS</h3>
                <p>In AEM as a Cloud Service, Dispatcher configuration is deployed via Git and Cloud Manager. Keep these points in mind:</p>
                <ul>
                    <li>Store Dispatcher configs in: <code>/dispatcher/src/conf.d/</code> and <code>/dispatcher/src/conf.dispatcher.d/</code></li>
                    <li>Validate configuration using Adobe's <code>dispatcher-sdk</code> locally before committing.</li>
                    <li>Use different folders for <code>development</code>, <code>stage</code>, and <code>production</code> configurations if needed.</li>
                    <li>Keep custom headers, caching, and filters isolated and organized.</li>
                </ul>
                <h4>Useful Commands</h4>
                <pre>
# Validate dispatcher config locally
$ dispatcher-sdk validate .

# Build for deployment
$ mvn clean install</pre>
                <h3>4. Akamai Integration with AEM</h3>
                <p><strong>Akamai</strong> is a leading Content Delivery Network (CDN) that helps improve performance, scalability, and security of AEM-powered websites. When used with Dispatcher, it forms an additional caching layer, serving content closer to the end-user and reducing load on your web and AEM servers.</p>
                <h4>🔁 Caching Behavior</h4>
                <ul>
                    <li>CDN cache sits in front of Dispatcher and serves cached content globally.</li>
                    <li>Akamai fetches content from Dispatcher only when there's a cache miss.</li>
                    <li>You can set cache duration via <code>Cache-Control</code> and <code>Expires</code> headers.</li>
                </ul>
                <pre>Browser → Akamai Edge → Dispatcher → AEM Publish</pre>
                <h4>🛠️ Required Configuration</h4>
                <ul>
                    <li>
                        <strong>HTTP Headers:</strong> Configure AEM Dispatcher to return appropriate headers:
                        <pre>
Header set Cache-Control "public, max-age=86400"
Header set Expires "Wed, 15 Nov 2025 12:00:00 GMT"</pre>
                    </li>
                    <li><strong>Invalidation:</strong> Use Akamai's Fast Purge or CP Codes to clear cache after AEM publishes.</li>
                    <li><strong>Custom Rules:</strong> Akamai allows path-based rules to bypass cache or apply geo-targeting.</li>
                </ul>
                <h4>🔐 Security Headers & SSL</h4>
                <p>Akamai can enforce SSL, WAF rules, and add security headers globally:</p>
                <pre>
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Frame-Options: SAMEORIGIN
Content-Security-Policy: default-src 'self'</pre>
                <h4>🚀 Performance Tips</h4>
                <ul>
                    <li>Use Akamai's Image & Adaptive Acceleration features for optimizing media.</li>
                    <li>Ensure consistent cache keys: normalize query parameters using Akamai settings.</li>
                    <li>Use EdgeWorkers for lightweight JS logic at the edge.</li>
                </ul>
                <h4>📢 In AEMaaCS</h4>
                <p>For AEM as a Cloud Service, Akamai configuration is managed via Adobe Cloud Manager in conjunction with Adobe-managed CDN settings. Custom Akamai configs must be coordinated with Adobe support.</p>
                <h3>5. Testing Tips</h3>
                <ul>
                    <li>Use <code>curl</code> or Postman to test Dispatcher behavior (headers, caching, invalidation).</li>
                    <li>Tail Dispatcher logs and Apache logs during tests: <code>tail -f /var/log/httpd/dispatcher.log</code></li>
                    <li>Test edge cases like query params, POST requests, unauthorized access, etc.</li>
                    <li>Use Lighthouse or WebPageTest to measure caching performance.</li>
                </ul>
                <h4>Examples:</h4>
                <pre>
# Test cache hit
curl -I http://localhost/content/mysite/en.html

# Invalidate cache via flush agent
curl -X POST http://localhost:4503/dispatcher/invalidate.cache</pre>
            </section>
            <section class="card" id="resource-mapping">
                <h2>📍 Resource Mapping and Clean URLs</h2>
                <p>AEM's <strong>Resource Mapping</strong> feature allows you to define clean, user-friendly, and SEO-optimized URLs by mapping internal repository paths (like <code>/content/site/en</code>) to shorter, external URLs (like <code>/en</code> or <code>/home</code>).</p>
                <h3>🔍 Why Use Resource Mapping?</h3>
                <ul>
                    <li>Remove internal prefixes like <code>/content</code> or <code>/etc</code> from URLs</li>
                    <li>Redirect legacy URLs to new ones</li>
                    <li>Support language-based paths like <code>/en</code>, <code>/fr</code>, etc.</li>
                    <li>Improve SEO and user readability</li>
                </ul>
                <h3>📁 Where to Configure Resource Mapping</h3>
                <p>Resource mapping is configured using the special path: <code>/etc/map</code> (or <code>/conf/global/settings/mapping</code> in newer AEM versions). You can create this structure via CRXDE or package manager.</p>
                <ul>
                    <li><strong>CRX Path:</strong> <code>/etc/map/http</code></li>
                    <li><strong>Example Node:</strong> <code>/etc/map/http/localhost.4503</code></li>
                </ul>
                <p>Each node under <code>/etc/map</code> represents a mapping rule based on hostname and path.</p>
                <h3>🛠 Example 1: Remove <code>/content</code> from URLs</h3>
                <p>To convert <code>/content/mysite/en/home</code> to <code>/en/home</code>:</p>
                <pre>
+ http (sling:Folder)
  + localhost.4503 (sling:Mapping)
    - sling:match = "/en/home"
    - sling:internalRedirect = "/content/mysite/en/home"</pre>
                <h3>🛠 Example 2: Redirect Legacy Path</h3>
                <p>Redirect <code>/old-products</code> to <code>/products</code>:</p>
                <pre>
+ http
  + localhost.4503
    - sling:match = "/old-products"
    - sling:redirect = "/products"</pre>
                <h3>⚙️ Tips</h3>
                <ul>
                    <li>Always test resource mapping with Dispatcher caching in mind — improper mappings can break cache invalidation.</li>
                    <li>Mappings are resolved before the request hits the resource resolver. They should be optimized and minimal.</li>
                    <li>Use AEM's <strong>Resource Resolver Factory</strong> to debug mappings in Java code.</li>
                </ul>
                <h3>📁 Resource Resolver Factory Config</h3>
                <p>You can also control mapping behavior using the OSGi config: <code>org.apache.sling.jcr.resource.internal.JcrResourceResolverFactoryImpl</code></p>
                <ul>
                    <li><strong>resource.resolver.mapping:</strong> List of mappings (e.g., <code>/content/:/</code>)</li>
                    <li><strong>resource.resolver.virtual:</strong> Virtual URLs to be recognized</li>
                </ul>
                <h3>🚀 Impact on Dispatcher</h3>
                <p>Dispatcher caching is directly affected by URL structure. So when using Resource Mapping:</p>
                <ul>
                    <li>Ensure mapped URLs are covered in your <code>/rules</code> and <code>/cache</code> sections</li>
                    <li>Update rewrite rules in <code>rewrite.rules</code> or <code>vhost.conf</code> (Apache/IIS)</li>
                    <li>Enable statfileslevel accordingly for nested clean paths</li>
                </ul>
            </section>
            <section class="card">
                <h2>CDN Integration with AEM and Dispatcher</h2>
                <p>A <strong>Content Delivery Network (CDN)</strong> is a distributed network of servers strategically located across the globe. CDNs cache and deliver static and dynamic web content (e.g., images, videos, HTML, JS, CSS) to end-users from the nearest edge location, reducing latency and improving performance.</p>
                <h3>📌 Why Use CDN with AEM?</h3>
                <ul>
                    <li>Reduce page load time by serving assets from geographically closer servers</li>
                    <li>Offload bandwidth and requests from Dispatcher and AEM Publish</li>
                    <li>Enable better scalability and availability during traffic spikes</li>
                    <li>Add additional security features like DDoS protection, WAF (Web Application Firewall), etc.</li>
                </ul>
                <h3>🔗 Typical Flow: AEM + Dispatcher + CDN</h3>
                <pre>
Browser → CDN (e.g., Cloudflare, Akamai, AWS CloudFront)
    ↓ (Cache Miss)
Dispatcher (Apache/IIS)
    ↓
AEM Publish Server</pre>
                <h3>🛠️ How to Integrate a CDN</h3>
                <ol>
                    <li><strong>Deploy Dispatcher behind CDN:</strong> Point your CDN to the Dispatcher endpoint (usually Apache/IIS behind a public IP).</li>
                    <li><strong>Set proper Cache-Control headers:</strong> Ensure Dispatcher sets correct headers (<code>Cache-Control</code>, <code>Expires</code>) so CDN knows how long to cache.</li>
                    <li><strong>Configure CDN rules:</strong> Set caching rules, purge policies, and edge logic in the CDN dashboard.</li>
                    <li><strong>Whitelist CDN IPs:</strong> If you restrict IPs in Dispatcher, allow the IP range of your CDN provider.</li>
                    <li><strong>Enable HTTPS:</strong> Secure traffic between user ↔ CDN and CDN ↔ Dispatcher with SSL certificates.</li>
                </ol>
                <h3>🧠 Example: Cache-Control Header for CDN</h3>
                <p>Set in Dispatcher (Apache <code>.vhost</code> or <code>dispatcher.any</code> response header rules):</p>
                <pre>Header set Cache-Control "max-age=86400, public"</pre>
                <p>This allows the CDN to cache content for 1 day (86400 seconds).</p>
                <h3>🧹 Purging CDN Cache</h3>
                <p>CDN caches can be purged either:</p>
                <ul>
                    <li>Automatically via <strong>CI/CD pipelines</strong> after deployments</li>
                    <li>Using CDN's <strong>admin dashboard</strong> or API (e.g., Cloudflare purge API)</li>
                    <li>Via Dispatcher <strong>Flush Agents</strong> for origin cache, and CDN <strong>Webhooks</strong> for edge cache</li>
                </ul>
                <h3>⚠️ Important Considerations</h3>
                <ul>
                    <li><strong>Stale Content:</strong> Set proper cache invalidation rules to avoid stale delivery</li>
                    <li><strong>Authentication:</strong> Secure dynamic endpoints — don't cache authenticated pages</li>
                    <li><strong>Edge Rules:</strong> Configure CDN to skip caching on sensitive routes (e.g., /libs, /bin)</li>
                    <li><strong>Query Parameters:</strong> Many CDNs treat URLs with query parameters differently — ensure Dispatcher and CDN ignore or allow the same patterns</li>
                </ul>
                <h3>✅ CDN Vendors Commonly Used with AEM</h3>
                <ul>
                    <li><strong>Cloudflare</strong> - CDN + DNS + WAF</li>
                    <li><strong>Akamai</strong> - Enterprise-grade global CDN</li>
                    <li><strong>Amazon CloudFront</strong> - Great for AWS-hosted AEM setups</li>
                    <li><strong>Fastly</strong> - Fast dynamic content caching</li>
                </ul>
                <h3>📘 Tip: CDN with AEM as a Cloud Service (AEMaaCS)</h3>
                <p>In AEMaaCS, Adobe uses <strong>Fastly CDN by default</strong> in the cloud infrastructure. However, custom CDN configurations can be added using Cloud Manager's Git-based config.</p>
                <h3>🚀 Best Practices</h3>
                <ul>
                    <li>Test CDN behavior with different file types and headers</li>
                    <li>Use CDN logs and analytics to monitor cache hits/misses</li>
                    <li>Integrate CDN purge into deployment pipelines</li>
                    <li>Combine with Dispatcher for a two-level caching strategy (CDN edge + Dispatcher origin)</li>
                </ul>
            </section>
            <section class="card">
                <h2>Dispatcher in AEM as a Cloud Service (AEMaaCS)</h2>
                <p>In AEMaaCS, the Dispatcher setup is managed by Adobe's Cloud infrastructure. You cannot access or directly modify Dispatcher files on the server. Instead, all configurations are deployed via <strong>Cloud Manager</strong> using a Git-based CI/CD pipeline.</p>
                <h3>Key Characteristics</h3>
                <ul>
                    <li><strong>Managed Dispatcher:</strong> Adobe handles server infrastructure, load balancing, and Dispatcher module setup.</li>
                    <li><strong>Git-Driven Configuration:</strong> Dispatcher rules and filters are stored and managed in a Git repository.</li>
                    <li><strong>Automated Deployments:</strong> Code and configuration changes are deployed via Cloud Manager pipelines.</li>
                </ul>
                <h3>Dispatcher Folder Structure in AEMaaCS</h3>
                <p>The Dispatcher configuration typically lives inside your project repo at:</p>
                <pre>
dispatcher/
├── src/
│   ├── conf.d/
│   │   ├── available_vhosts/
│   │   └── enabled_vhosts/
│   └── conf.dispatcher.d/
│       ├── cache/
│       ├── filters/
│       ├── farms/
│       └── rewrites/
├── conf/
└── README.md</pre>
                <h3>Deployment via Cloud Manager</h3>
                <ul>
                    <li>All changes to Dispatcher must go through Cloud Manager pipelines.</li>
                    <li>Pipelines validate, build, and deploy Dispatcher rules along with AEM code.</li>
                    <li>Use Adobe's <code>dispatcher-sdk</code> to validate configs locally before committing.</li>
                </ul>
                <h4>Validate Locally Using dispatcher-sdk:</h4>
                <pre>
# Install dispatcher SDK if not already installed
npm install -g @adobe/dispatcher-sdk

# Validate configuration
dispatcher-sdk validate .</pre>
                <h3>Best Practices</h3>
                <ul>
                    <li>Use environment-specific folders (dev, stage, prod) if needed.</li>
                    <li>Split <code>filters</code>, <code>caching</code>, and <code>rewrites</code> into modular config files.</li>
                    <li>Keep vhost definitions clean and organized.</li>
                    <li>Test all changes in non-prod pipelines before deploying to production.</li>
                </ul>
                <p><strong>Note:</strong> Avoid manual changes on the server. Everything must be managed via version-controlled code and deployed through approved pipelines.</p>
            </section>
            <script src="https://utteranc.es/client.js" repo="ashishrajbhagat/aem-tutorial" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
        </main>
        <script src="../js/script.js"></script>
    </body>
</html>